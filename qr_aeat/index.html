<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de QR</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center">Generador de Código QR</h2>
        <form id="qrForm" class="mt-2">
            <div class="col-12  mb-4">
                <div class="row">
                    <div class="col-4">
                        <label for="text">NIF</label>
                    </div>
                    <div class="col-8">
                        <input type="text" id="nif" class="form-control" required value="89890001K">
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label for="text">SERIE</label>
                    </div>
                    <div class="col-8">
                        <input type="text" id="serie" class="form-control" required value="12345678&G33">
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label for="text">FECHA</label>
                    </div>
                    <div class="col-8">
                        <input type="text" id="fecha" class="form-control" required value="01-01-2024">
                    </div>
                </div>
                <div class="row">
                    <div class="col-4">
                        <label for="text">IMPORTE</label>
                    </div>
                    <div class="col-8">
                        <input type="text" id="importe" class="form-control" required value="241.4">
                    </div>
                </div>

            </div>
            <button type="button" id="genera_qr" class="btn btn-primary btn-block">Generar QR</button>
            <button type="button" id="valida_qr" class="btn btn-primary btn-block">Valida QR</button>
        </form>
        <div class="mt-4 text-center">
            <h4>Tu Código QR</h4>
            <div id="qrResult" class="mt-3">
                <img id="qrImage" src="" alt="Código QR" class="img-thumbnail" style="display: none;">
            </div>
        </div>
        
        <div class="mt-4 text-center">
            <h4>Valida QR</h4>
            <div id="qrResultJson" class="mt-3">
                <textarea id="valida_json" rows="4" class="form-control" style="display: none;"></textarea>
            </div>
        </div>
    </div>

    <script>
        async function generaQR(json=false){
            let param_nif = $('#nif').val();
            let param_serie = $('#serie').val();
            let param_fecha = $('#fecha').val();
            let param_importe = $('#importe').val();
            
            // let qrUrl = 'phpqr_endroid.php?param_nif='+nif+'&param_numserie='+serie+'&param_fecha='+fecha+'&param_importe='+importe
            let qrUrl = 'phpqr.php'
    
            let _datos = {
                param_nif:encodeURIComponent(param_nif), 
                param_serie:encodeURIComponent(param_serie), 
                param_fecha:encodeURIComponent(param_fecha), 
                param_importe:encodeURIComponent(param_importe)
            }
            if(json){
                _datos.param_formato = 'json'
            }
    
            let response_bruto = await fetch(qrUrl, {
                method: "POST",
                body: JSON.stringify(_datos),
                headers: {"Content-type": "application/x-www-form-urlencoded"}
            })
            return await response_bruto.text()
            // .then(data => {
            //     return data.text();
            // })
            // .then(msg => {
            //     return msg;
            // })

        }

        $('#genera_qr').on('click', async function(e) {
            e.preventDefault();
            /*
            let param_nif = $('#nif').val();
            let param_serie = $('#serie').val();
            let param_fecha = $('#fecha').val();
            let param_importe = $('#importe').val();
            
            // let qrUrl = 'phpqr_endroid.php?param_nif='+nif+'&param_numserie='+serie+'&param_fecha='+fecha+'&param_importe='+importe
            let qrUrl = 'phpqr_endroid.php'

            let _datos = {
                param_nif:encodeURIComponent(param_nif), 
                param_serie:encodeURIComponent(param_serie), 
                param_fecha:encodeURIComponent(param_serie), 
                param_importe:encodeURIComponent(param_importe)
            }

            fetch(qrUrl, {
                method: "POST",
                body: JSON.stringify(_datos),
                headers: {"Content-type": "application/x-www-form-urlencoded"}
            })
            .then(data => {
                return data.text();
            })
            .then(msg => {
                $('#qrImage').attr('src', msg).show();
            })
            */
           
            let generaQr = await generaQR();
            $('#qrImage').attr('src', generaQr).show();

            // $.ajax({
            //     method: "GET",
            //     url: qrUrl,
            // }).done(function(msg) {
            //     $('#qrImage').attr('src', msg).show();
            // });

            //  $.ajax({
            //     method: "POST",
            //     url: qrUrl,
            //     data:_datos,
            //     contentType: 'application/x-www-form-urlencoded',
            // }).done(function(msg) {
            //     $('#qrImage').attr('src', msg).show();
            // });
            
        });
    
        $('#valida_qr').on('click', async function(e){
            let qrTemporal = await generaQR(true);
            $('#valida_json').val(qrTemporal).show();
        })
    
    </script>
</body>
</html>
